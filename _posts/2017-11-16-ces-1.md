---
layout: post
author: skyousuke
title: "มาทำความรู้จักกับ Entity System"
category: entity-system
image: "https://telluric-chimneys.000webhostapp.com/images/ces-0.png"
lang: th_TH
---
การสร้างสิ่งต่างๆภายในเกมแบบเก่า เราจะใช้หลักการ OOP ก็คือ สิ่งต่างๆภายในเกมทุกตัวเป็น Object แล้วก็ถูกสร้างขึ้นจาก Class  และให้แต่ละ Class ที่มีคุณสมบัติคล้ายๆกันก็จะมีการสืบทอดกันต่อไปเรื่อยๆ สิ่งเหล่านี้ทำให้เกิดโครงสร้างลำดับชั้นของ Class ขนาดใหญ่ยึดติดกันแน่น ยิ่งเกมมีสิ่งต่างๆเยอะขึ้นเรื่อยๆ เราก็จะเพิ่ม Class ใหม่ๆเข้าไปในลำดับชั้นได้ยากขึ้น

## การสร้าง Object แบบเกาด้วย OOP และข้อเสียของมัน

สมมุติให้เกมเรามี Object อยู่ 4 อย่าง ได้แก่

1. ผู้เล่น (Player)
2. ศัตรู (Enemy)
3. ก้อนหิน (Rock)
4. ต้นไม้ (Tree)

เราแบ่งลักษณะของ Object เป็นแบบ `เคลื่อนที่ได้ (Dynamic)` และ `อยู่กับที่ (Static)` จะเขียน class diagram ได้ดังรูป

![](https://telluric-chimneys.000webhostapp.com/images/ces-2.png)

ทีนี้เราอยากเพิ่ม Object ตัวที่ 5 เข้ามาใหม่ ซึ่งเป็น `ต้นไม้ปีศาจ (EvilTree)` โดยที่ต้องเป็น Object แบบ `อยู่กับที่ (Static)` และเป็น `ศัตรู (Enemy)` ด้วย แต่ว่า `อ้าว! มันทำไม่ได้นิ` เพราะมันต้องสืบทอด 2 Class พร้อมๆกันเลย ซึ่งใน `Java ไม่สามารถทำได้!` แล้วเราจะเลือกสืบทอดอันไหนดีเนี่ย!

![](https://telluric-chimneys.000webhostapp.com/images/ces-3.png)

ดังนั้น การใช้ระบบสืบทอด Class อาจจะไม่เหมาะกับการพัฒนาเกมขนาดใหญ่ ที่มีการเพิ่มสิ่งใหม่ๆอยู่ตลอดเวลา

## การสร้าง Object แบบใหม่ด้วย Entity System

ในการแก้ปัญหาข้างต้น Game Programmer หลายคนจึงเปลี่ยนมาใช้วิธีการสร้าง Object แบบใหม่โดยใช้สิ่งที่เรียกว่า Entity System

### Entity System คืออะไร?

Entity system (หรือรู้จักกันในชื่อ Component Entity System: CES) เป็น Pattern การเขียนโปรแกรมอย่างหนึ่งที่นิยมใช้ในการพัฒนาเกม CES ประกอบด้วย 3 ส่วนหลักๆ ได้แก่

1. Component (C)
2. Entity (E)
3. System (S)

**Entity**

เป็นตัวแทนของสิ่งต่างๆในเกม แต่พวกมันเป็นเพียง `Unique ID`

**Component**

เป็นเพียง `ข้อมูล (Data)` โดยข้อมูลที่ว่านี่ก็คือพวกสถานะต่างๆของ Entity เช่น

* ตำแหน่ง X Y
* ความเร็ว
* Sprite
* พลังชีวิต

**System**

เป็นส่วน `ลอจิก (Logic)` ที่ทำงานกับ Component ต่างๆ เช่น

* ระบบการเคลื่อนที่
* ระบบแรงโน้มถ่วง
* ระบบการ Render ภาพ

### Entity System ทำงานอย่างไร?

ถ้าลองพิจารณา Object ใน OOP ดีๆแล้ว มันก็คือ `ข้อมูล` และ `ลอจิก` ที่ผสมอยู่รวมกัน (`ข้อมูล` ก็คือสถานะต่างๆของ Object นั้น ส่วน `ลอจิก` ก็คือ Code ใน Method ที่ทำงานกับ `ข้อมูล` เหล่านั้น) ซึ่ง Entity system ก็ได้ทำการแยก `ข้อมูล` และ `ลอจิก` เหล่านั้นออกจากกันเป็น Component กับ System นั่นเอง โดยมี Entity ที่เป็น ID ไว้คอยระบุว่า `ข้อมูล` ตัวนี้ แทนสถานะของสิ่งใดที่อยู่ในเกม 

เราอาจจะมอง Entity เปรียบเสมือน Record ใน Database ส่วน Component ก็เป็นข้อมูลจริงๆของ Record นั้นก็ได้

<table style="text-align: center;">
  <thead>
    <tr>
      <th></th>
      <th>component ตำแหน่ง Xํ Y</th>
      <th>component Sprite</th>
      <th>compoent พลังชีวิต</th>
    </tr>    
  </thead>
  <tbody>
    <tr>
      <td><b>entity1</b></td>
      <td>{x: 0, y: 0}</td>
      <td>player.png</td>
      <td>100</td>
    </tr>
    <tr>
      <td><b>entity2</b></td>
      <td>{x: 5, y: 5}</td>
      <td>npc.png</td>
      <td>50</td>
    </tr>
    <tr>
      <td><b>entity3</b></td>
      <td>{x: -10, y: -20}</td>
      <td>monster.png</td>
      <td>33</td>
    </tr>
  </tbody>
</table>

ข้อมูล (Component) ของ Record (Entity) เหล่านี้ก็จะถูกปรับเปลี่ยนค่าโดย `System` ต่างๆที่เกี่ยวข้องกับมัน เช่น System การเคลื่อนที่ ก็จะทำการเปลี่ยนแปลง Component ตำแหน่ง เป็นต้น ทำให้ค่าสถานะต่างๆของ Entity แต่ละตัวมันเปลี่ยนค่าไป และสิ่งนี้ทำให้โลกภายในเกมมีการอัพเดทนั่นเอง

### ข้อดีของ Entity System เมื่อเทียบกับ OOP

![](https://telluric-chimneys.000webhostapp.com/images/ces-1.png)

1. การแยกส่วนของ `ข้อมูล` และ `ลอจิก` ออกจากกัน ทำให้ไม่ลำดับชั้นของ Class ขนาดใหญ่ ซึ่งช่วยให้เพิ่มสิ่งใหม่ๆได้ง่ายกว่า
2. การแยกส่วน `ข้อมูล` ออกมา ช่วยให้นำส่วน `ข้อมูล` นั้นมา `ใช้ซ้ำ (reuse)` ได้มีประสิทธิภาพมากกว่าแบบ OOP
3. สามารถเพิ่มหรือลด `ข้อมูล` บน Entity ขณะ Runtime ได้ ทำให้สร้าง Entity แบบใหม่ๆได้ โดยไม่จำเป็นต้องสร้าง Class ใหม่
4. หากเกมมีขนาดใหญ่แล้ว Entity System จะทำงานได้เร็วกว่า เพราะใช้ Memory ได้อย่างมีประสิทธิภาพมากกว่า 

### ข้อเสียของ Entity System เมื่อเทียบกับ OOP

1. ใช้เวลาเขียน Code นานกว่า เพราะต้องเขียน Engine ขึ้นมาก่อน (แก้ได้โดยการหา Library หรือ Framework มาใช้งาน)
2. ต้องคิด `ลอจิก` มากกว่า เพราะ Entity แต่ละตัวเป็นเพียง ID เท่านั้น ถ้าจะสื่อสารระหว่าง Entity ด้วยกันต้องมี `ลอจิก` เพิ่ม
3. ถ้าออกแบบ Component และ System ได้ไม่ดี Code จะออกมาแย่กว่าแบบ OOP และทำให้เปลืองสมองมากกว่า
4. ไม่เหมาะกับเกมขนาดเล็กที่มีการ Reuse `ข้อมูล` น้อย เพราะข้อเสียจะมีมากกว่าข้อดี

## สรุป

Entity System เป็น Pattern การเขียนโปรแกรมที่ช่วยแก้ปัญหาลำดับชั้นของ Class ขนาดใหญ่ที่เกิดขึ้นจากการสืบทอด Classโดยแนวคิดแบบ OOP โดยที่ Entity System มองว่าสิ่งต่างๆภายในเกมก็คือ Entity ที่เป็นเพียง `Unique ID` เท่านั้น และพวกมันถูกนิยามจากกลุ่มของ `ข้อมูล` ที่เรียกว่า Component ซึ่งข้อมูลเหล่านี้ถูกจัดการด้วย `ลอจิก` ที่อยู่ใน System ต่างๆ

บทความนี้เป็นเพียงการแนะนำ Entity System เบื้องต้น ในครั้งหน้าเราจะมาลงเมื่อเขียน Code ดูการทำงานจริงๆของ Entity System กัน จะได้เข้าใจมากยิ่งขึ้น

